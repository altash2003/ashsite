<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myUser = null;
    const DEMO_USER = 'ashleychan'; // Auto-login as this user

    // --- INIT ---
    socket.emit('player:login', DEMO_USER);

    // --- LISTENERS ---
    socket.on('player:login_success', (u) => {
        myUser = u;
        updateUI();
    });

    socket.on('sync:full_data', (db) => {
        // 1. Update My User Data
        if(myUser) {
            const me = db.players.find(p => p.id === myUser.id);
            if(me) { myUser = me; updateUI(); }
        }

        // 2. Update Auction Grid
        const aucGrid = document.querySelector('#sec-auction .grid-3');
        if(aucGrid) {
            aucGrid.innerHTML = '';
            db.auctions.forEach(a => {
                if(a.status !== 'Active') return;
                const minBid = parseInt(a.bid) + 100;
                aucGrid.innerHTML += `
                <div class="card-base">
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <h3>${a.item}</h3>
                            <span style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px;">Active</span>
                        </div>
                        <div style="height: 150px; display: grid; place-items: center; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 1rem;">
                            <img src="${a.img}" style="max-height:100%; max-width:100%;">
                        </div>
                        <p style="color:#fbbf24; text-align:center; margin-bottom:10px;">Current Bid: ${a.bid} (${a.bidder || 'None'})</p>
                        <button class="btn btn-primary" style="width: 100%;" onclick="placeBid(${a.id}, ${minBid})">Bid ${minBid}</button>
                    </div>
                </div>`;
            });
        }

        // 3. Update Store Grid
        const storeGrid = document.querySelector('#sec-store .grid-4');
        if(storeGrid) {
            storeGrid.innerHTML = '';
            db.storeItems.forEach(i => {
                if(i.status !== 'Available') return;
                storeGrid.innerHTML += `
                <div class="card-base" style="padding: 1.5rem;">
                    <img src="${i.img}" style="width:100%; height:100px; object-fit:cover; border-radius:10px; margin-bottom:1rem;">
                    <h4>${i.name}</h4>
                    <p style="color: #fbbf24; font-weight: bold; margin: 5px 0 15px;">${i.price} Credits</p>
                    <button class="btn" style="width: 100%; background: rgba(16, 185, 129, 0.2); color: #10b981;" onclick="buyItem(${i.id})">Buy</button>
                </div>`;
            });
        }

        // 4. Update Inventory
        const invGrid = document.querySelector('#sec-inventory div');
        if(invGrid && myUser) {
            invGrid.innerHTML = '';
            myUser.inventory.forEach(item => {
                invGrid.innerHTML += `
                <div style="aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; flex-direction:column; align-items:center; justify-content:center; border: 1px solid rgba(255,255,255,0.1); padding:10px;">
                    <img src="${item.img}" style="width:60px; height:60px; margin-bottom:5px;">
                    <span style="font-size:0.8rem; text-align:center;">${item.name}</span>
                </div>`;
            });
        }
    });

    // --- ACTIONS ---
    function placeBid(aucId, amount) {
        socket.emit('player:place_bid', { userId: myUser.id, aucId, bid: amount });
    }

    function buyItem(itemId) {
        socket.emit('player:buy_item', { userId: myUser.id, itemId });
    }

    function claimReward() {
        const btn = document.getElementById('claim-btn');
        btn.innerHTML = "CLAIMED!";
        btn.disabled = true;
        btn.style.background = "#4ade80"; 
        
        socket.emit('player:claim_daily', { userId: myUser.id, amount: 40 });
        
        setTimeout(closeRewards, 1000);
    }

    function updateUI() {
        if(!myUser) return;
        document.getElementById('credit-display').innerText = myUser.credits.toLocaleString();
        document.getElementById('page-desc').innerText = `Welcome back, ${myUser.user}.`;
    }

    // --- UI NAVIGATION (Your existing logic) ---
    function switchTab(tabName, navElement) {
        document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
        if(navElement) navElement.classList.add('active');
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById('sec-' + tabName);
        if(target) target.classList.remove('hidden');
    }
    function openRewards() { document.getElementById('rewards-modal').classList.add('open'); }
    function closeRewards() { document.getElementById('rewards-modal').classList.remove('open'); }

</script>
